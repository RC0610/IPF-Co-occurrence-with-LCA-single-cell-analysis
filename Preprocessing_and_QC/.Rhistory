scRNA <- RunHarmony(scRNA,
group.by.vars = "orig.ident",
theta = 2
plot_convergence = TRUE)
qc_report <- paste(
"=== QUALITY CONTROL REPORT ===",
paste0("\nGenerated: ", format(Sys.time(), "%Y-%m-%d %H:%M:%S %Z")),
paste0("\nInitial cells: " ncol_original),
#### 13. 生成质控报告 ####
batch_stats <- as.data.frame(table(Sample_ID = scRNA$orig.ident))
colnames(batch_stats) <- c("Sample_ID", "Cells_After_QC")
# 计算各阈值过滤的细胞数（来自 scRNA_pre）
filtered_stats <- data.frame(
Reason = c("Low nFeature_RNA", "High nFeature_RNA",
"Low nCount_RNA", "High nCount_RNA",
"High MT%", "High HB%"),
Cells = c(
sum(scRNA_pre$nFeature_RNA < QC_THRESHOLDS$nFeature_RNA[1]),
sum(scRNA_pre$nFeature_RNA > QC_THRESHOLDS$nFeature_RNA[2]),
sum(scRNA_pre$nCount_RNA < QC_THRESHOLDS$nCount_RNA[1]),
sum(scRNA_pre$nCount_RNA > QC_THRESHOLDS$nCount_RNA[2]),
sum(scRNA_pre$percent.mt >= QC_THRESHOLDS$percent_mt),
sum(scRNA_pre$percent.HB >= QC_THRESHOLDS$percent_hb)
)
)
qc_report <- paste(
"=== QUALITY CONTROL REPORT ===",
paste0("\nGenerated: ", format(Sys.time(), "%Y-%m-%d %H:%M:%S %Z")),
paste0("\nInitial cells: " ncol_original),
# 计算各阈值过滤的细胞数（来自 scRNA_pre）
filtered_stats <- data.frame(
Reason = c("Low nFeature_RNA", "High nFeature_RNA",
"Low nCount_RNA", "High nCount_RNA",
"High MT%", "High HB%"),
Cells = c(
sum(scRNA_pre$nFeature_RNA < QC_THRESHOLDS$nFeature_RNA[1]),
sum(scRNA_pre$nFeature_RNA > QC_THRESHOLDS$nFeature_RNA[2]),
sum(scRNA_pre$nCount_RNA < QC_THRESHOLDS$nCount_RNA[1]),
sum(scRNA_pre$nCount_RNA > QC_THRESHOLDS$nCount_RNA[2]),
sum(scRNA_pre$percent.mt >= QC_THRESHOLDS$percent_mt),
sum(scRNA_pre$percent.HB >= QC_THRESHOLDS$percent_hb)
)
)
qc_report <- paste(
"=== QUALITY CONTROL REPORT ===",
paste0("\nGenerated: ", format(Sys.time(), "%Y-%m-%d %H:%M:%S %Z")),
paste0("\nInitial cells: " ncol_original),
